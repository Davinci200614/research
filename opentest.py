import csv
import os
import time
from openai import OpenAI
from dotenv import load_dotenv

load_dotenv()

client = OpenAI(api_key=os.getenv("OPENAI_API_KEY"))

# ── Config ──
CSV_FILE = os.path.join(os.path.dirname(__file__), "Artist_Research - Artist.csv")
TOUR_COL = "Link to Tour(artist website)"


def read_csv(path):
    with open(path, "r", encoding="utf-8-sig") as f:
        reader = csv.reader(f)
        headers = next(reader)
        return headers, list(reader)


def write_csv(path, headers, rows):
    with open(path, "w", encoding="utf-8-sig", newline="") as f:
        w = csv.writer(f)
        w.writerow(headers)
        w.writerows(rows)


def get_tour_link(artist_name):
    """Use OpenAI with web search to find the official tour/website link for an artist."""
    prompt = (
        f"Search the web for the official tour page or official website of the artist \"{artist_name}\". "
        f"Return ONLY the URL. No text, no explanation, no markdown. Just the raw URL."
    )
    try:
        response = client.responses.create(
            model="gpt-4o",
            tools=[{"type": "web_search"}],
            input=prompt,
        )
        url = response.output_text.strip()
        # Basic validation — should look like a URL
        if url.startswith("http://") or url.startswith("https://"):
            return url
        print(f"   ⚠ Unexpected response for {artist_name}: {url[:120]}")
        return url  # return it anyway, user can review
    except Exception as e:
        print(f"   ✗ Error fetching tour link for {artist_name}: {e}")
        return None


def main():
    headers, rows = read_csv(CSV_FILE)

    if TOUR_COL not in headers:
        print(f"ERROR: Column '{TOUR_COL}' not found in CSV.")
        print(f"Available columns: {headers}")
        return

    tour_idx = headers.index(TOUR_COL)
    artist_idx = headers.index("Artist Name")

    print("Tour Link Filler\n")
    print("  1) Skip rows that already have a tour link")
    print("  2) Process all rows (overwrite existing links)\n")
    choice = input("Choose mode [1/2]: ").strip()
    skip_existing = choice != "2"

    to_process = []
    for i, row in enumerate(rows):
        while len(row) < len(headers):
            row.append("")
        name = row[artist_idx].strip()
        if not name:
            continue
        if skip_existing and row[tour_idx].strip():
            print(f"   Skipping {name} (already has tour link)")
            continue
        to_process.append((i, name))

    if not to_process:
        print("No artists to process. Done.")
        return

    mode_label = "empty rows only" if skip_existing else "all rows"
    print(f"\nMode: {mode_label}")
    print(f"Artists to process: {[name for _, name in to_process]}\n")

    for row_idx, name in to_process:
        print(f"  Searching tour link for: {name} ...")
        link = get_tour_link(name)
        if link:
            rows[row_idx][tour_idx] = link
            write_csv(CSV_FILE, headers, rows)
            print(f"   ✓ Saved: {link}")
        else:
            print(f"   ✗ No link found for {name}")
        time.sleep(1)  # small delay to avoid rate limits

    print("\nDone! CSV updated.")


if __name__ == "__main__":
    main()
